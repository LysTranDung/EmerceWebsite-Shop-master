@{
    ViewBag.Title = "Danh sách Sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="card">
    <div class="card-header">
        <h3 class="card-title">@ViewBag.Title</h3>
        <div class="card-tools">
            <a href="@Url.Action("ThemSP", "QLSP")" class="btn btn-primary btn-sm">Thêm sản phẩm mới</a>
        </div>
    </div>
    <div class="card-body">
        <table id="tbl_products" class="table table-bordered table-hover">
        </table>
    </div>
</div>
@section scripts {
    <script>

    $(document).ready(function () {
        loadProducts();
    });


    function loadProducts() {
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetProducts", "QLSP")',
            success: function (response) {
                var tbl_products = $("#tbl_products");
                var html_str = "<thead><tr><th>STT</th><th>Tên sản phẩm</th><th>Giá</th><th>Tồn kho</th><th>Thương hiệu</th><th>Thao tác</th></tr></thead><tbody>";

 

                var productList = response.data;

                if (response.success === false) {
                    // Xử lý lỗi từ Controller (nếu có)
                    html_str += "<tr><td colspan='6' class='text-center text-danger'>Lỗi tải dữ liệu: " + response.message + "</td></tr>";
                }
                else if (productList && productList.length > 0) {
                    for (var i = 0; i < productList.length; i++) {
                        var product = productList[i]; // Lấy từ response.data

                        // Định dạng tiền tệ
                        var formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(product.Price);

                        html_str += "<tr>"
                            + "<td>" + (i + 1) + "</td>"
                            + "<td>" + product.ProductName + "</td>"
                            + "<td>" + formattedPrice + "</td>"
                            + "<td>" + product.Stock + "</td>"
                            + "<td>" + product.Brand + "</td>"
                            + "<td>"
                            // URL Sửa (sử dụng cú pháp query parameter an toàn)
                            + "<a href='@Url.Action("ChinhSua", "QLSP")?id=" + product.ProductID + "' class='btn btn-warning btn-sm'>Sửa</a> "
                            // Nút Xóa
                            + "<button type='button' class='btn btn-danger btn-sm' onclick='confirmDelete(" + product.ProductID + ")'>Xóa</button>"
                            + "</td>"
                            + "</tr>";
                    }
                } else {
                    html_str += "<tr><td colspan='6' class='text-center'>Chưa có sản phẩm nào.</td></tr>";
                }
                

                html_str += "</tbody>";
                tbl_products.html(html_str);
            },
            error: function (xhr, status, error) {
                console.log("Lỗi khi tải danh sách sản phẩm:", error);
                var tbl_products = $("#tbl_products");
                // Thêm thead để bảng không bị trống
                var error_html = "<thead><tr><th>STT</th><th>Tên sản phẩm</th><th>Giá</th><th>Tồn kho</th><th>Thương hiệu</th><th>Thao tác</th></tr></thead>";
                error_html += "<tbody><tr><td colspan='6' class='text-center text-danger'>Không thể tải được dữ liệu. Vui lòng kiểm tra console hoặc API Controller.</td></tr></tbody>";
                tbl_products.html(error_html);
            }
        });
    }

    // Hàm xác nhận và gọi API xóa
    function confirmDelete(productId) {
        if (confirm("Bạn có chắc chắn muốn xóa sản phẩm có ID = " + productId + " không?")) {
            $.ajax({
                type: "POST",
                url: '@Url.Action("Delete", "QLSP")',
                data: { id: productId },
                success: function (response) {
                    // API Delete trả về { success: true/false }
                    if (response.success) {
                        alert("Xóa sản phẩm thành công!");
                    } else {
                        alert("Xóa thất bại. Vui lòng kiểm tra lại Controller.");
                    }

                    // Tải lại danh sách sau khi xóa thành công/thất bại
                    loadProducts();
                },
                error: function (xhr, status, error) {
                    alert("Đã xảy ra lỗi kết nối khi xóa sản phẩm.");
                    console.log(error);
                }
            });
        }
    }
    </script>
}