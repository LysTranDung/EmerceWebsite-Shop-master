@{
    ViewBag.Title = "Thống kê Doanh thu";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<div class="app-content-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-6"><h3 class="mb-0">@ViewBag.Title</h3></div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item"><a href="@Url.Action("ThongKe", "ThongKe")">Báo cáo & Thống kê</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Thống kê Doanh thu</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<div class="app-content">
    <div class="container-fluid">
        <!-- BỘ LỌC -->
        <div class="card card-outline card-primary">
            <div class="card-header">
                <h3 class="card-title">Bộ lọc</h3>
            </div>
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Lọc theo</label>
                            <select id="filterType" class="form-control">
                                <option value="today">Hôm nay</option>
                                <option value="this_month" selected>Tháng này</option>
                                <option value="this_quarter">Quý này</option>
                                <option value="all">Tất cả hóa đơn</option>
                                <option value="custom">Tùy chọn ngày</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3" id="customDateRange" style="display: none;">
                        <div class="form-group">
                            <label>Từ ngày</label>
                            <input type="date" id="startDate" class="form-control" />
                        </div>
                    </div>
                    <div class="col-md-3" id="customDateRange2" style="display: none;">
                        <div class="form-group">
                            <label>Đến ngày</label>
                            <input type="date" id="endDate" class="form-control" />
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <button id="btnFilter" class="btn btn-primary w-100">Xem thống kê</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- BẢNG THỐNG KÊ DOANH THU -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Doanh thu chi tiết theo ngày</h3>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped" id="revenueTable">
                        <thead>
                            <tr>
                                <th style="width: 20%">Ngày</th>
                                <th style="width: 30%">Số đơn hàng</th>
                                <th style="width: 50%">Tổng doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dữ liệu sẽ được chèn vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
    $(document).ready(function () {
        // Xử lý ẩn/hiện ô chọn ngày
        $('#filterType').on('change', function () {
            if (this.value === 'custom') {
                $('#customDateRange, #customDateRange2').show();
            } else {
                $('#customDateRange, #customDateRange2').hide();
            }
        });

        // Gán sự kiện click cho nút "Xem thống kê"
        $('#btnFilter').on('click', fetchData);

        // Tự động tải dữ liệu cho "Tháng này" khi trang vừa load
        fetchData();
    });

    function fetchData() {
        const filterType = $('#filterType').val();
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();

        // Hiển thị trạng thái đang tải
        $('#revenueTable tbody').html('<tr><td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Đang tải dữ liệu...</td></tr>');

        $.ajax({
            url: '@Url.Action("GetData", "ThongKe")',
            type: 'POST',
            data: { filterType: filterType, startDate: startDate, endDate: endDate },
            dataType: 'json',
            success: function (data) {
                if (data.error) {
                    alert(data.error);
                    $('#revenueTable tbody').html(`<tr><td colspan="3" class="text-center text-danger">${data.error}</td></tr>`);
                    return;
                }
                updateRevenueTable(data.RevenueByDate);
            },
            error: function () {
                $('#revenueTable tbody').html('<tr><td colspan="3" class="text-center text-danger">Đã có lỗi xảy ra khi tải dữ liệu.</td></tr>');
            }
        });
    }

    function updateRevenueTable(data) {
        const tableBody = $('#revenueTable tbody');
        tableBody.empty(); // Xóa dữ liệu cũ

        if (data && data.length > 0) {
            data.forEach(item => {
                // Định dạng lại ngày tháng từ chuỗi JSON của Microsoft
                const date = new Date(parseInt(item.Date.substr(6)));
                const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                const formattedRevenue = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.TotalRevenue);

                const row = `<tr>
                                <td>${formattedDate}</td>
                                <td>${item.OrderCount}</td>
                                <td>${formattedRevenue}</td>
                             </tr>`;
                tableBody.append(row);
            });
        } else {
            tableBody.append('<tr><td colspan="3" class="text-center">Không có dữ liệu cho khoảng thời gian này.</td></tr>');
        }
    }
    </script>
}